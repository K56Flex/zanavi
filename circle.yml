machine:
  timezone:
    Europe/Vienna
  environment:
    EMU_: "zanavi21"
    XEMU_: "zanavi10"
    sdpath: "/storage/sdcard"
    Xsdpath: "/mnt/sdcard"
dependencies:
  cache_directories:
    - ~/.android
  pre:
    - sudo apt-get update > /dev/null 2> /dev/null
    - sudo apt-get install libpng12-dev > /dev/null 2> /dev/null
    - sudo apt-get install librsvg2-bin > /dev/null 2> /dev/null
    - sudo apt-get install libfreetype6-dev > /dev/null 2> /dev/null
    - sudo apt-get install libdbus-glib-1-dev > /dev/null 2> /dev/null
    - sudo apt-get install g++ > /dev/null 2> /dev/null
    - sudo apt-get install gettext > /dev/null 2> /dev/null
    - sudo apt-get install ant > /dev/null 2> /dev/null
    - sudo apt-get install libsaxonb-java > /dev/null 2> /dev/null
    - sudo apt-get install lib32stdc++6 > /dev/null 2> /dev/null
    - sudo apt-get install lib32z1 > /dev/null 2> /dev/null
    - sudo apt-get install zip > /dev/null 2> /dev/null
    - sudo apt-get install bc > /dev/null 2> /dev/null
    - sudo apt-get install libfftw3-double3
    - sudo apt-get install libmagickcore5
    - sudo apt-get install perlmagick
    - sudo apt-get install liblwp-useragent-determined-perl

    - bash ~/zanavi/ci/do_android.sh
test:
  pre:
    - mksdcard -l e 20000M sdcard.img
    - echo 'mtools_skip_check=1' > ~/.mtoolsrc

    - android list targets

    - if [ "$EMU_" == "zanavi21" ]; then echo "no" | android create avd -n zanavi21 -f -t android-21 --abi default/armeabi-v7a --skin "WXGA800-7in" ; fi
    - if [ "$EMU_" == "zanavi10" ]; then echo "no" | android create avd -n zanavi10 -f -t android-10 --abi default/armeabi --skin "WVGA854" ; fi
    
    - echo "$EMU_"
    - echo "$sdpath"

  override:
    - ls -al ~/android-build/navit/android/bin/
    - ls -al $CIRCLE_ARTIFACTS/
    #- fb-adb shell "df"
    #- fb-adb shell "df $sdpath/"

    - wget --no-check-certificate -t 10 -O ~/navitmap_005.bin "http://ci.zanavi.cc/data/france.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_002.bin "http://ci.zanavi.cc/data/germany.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_010.bin "http://ci.zanavi.cc/data/great_britain.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_001.bin "http://ci.zanavi.cc/data/austria.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_003.bin "http://ci.zanavi.cc/data/netherlands.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_004.bin "http://ci.zanavi.cc/data/belgium.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_006.bin "http://ci.zanavi.cc/data/italy.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_007.bin "http://ci.zanavi.cc/data/liechtenstein.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_008.bin "http://ci.zanavi.cc/data/luxembourg.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_009.bin "http://ci.zanavi.cc/data/switzerland.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_011.bin "http://ci.zanavi.cc/data/ireland.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_012.bin "http://ci.zanavi.cc/data/lithuania.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_013.bin "http://ci.zanavi.cc/data/poland.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_014.bin "http://ci.zanavi.cc/data/spain.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_015.bin "http://ci.zanavi.cc/data/portugal.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_016.bin "http://ci.zanavi.cc/data/us-midwest.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_017.bin "http://ci.zanavi.cc/data/us-northeast.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_018.bin "http://ci.zanavi.cc/data/us-pacific.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_019.bin "http://ci.zanavi.cc/data/us-south.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_020.bin "http://ci.zanavi.cc/data/us-west.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_021.bin "http://ci.zanavi.cc/data/central_america.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_022.bin "http://ci.zanavi.cc/data/south_america.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_023.bin "http://ci.zanavi.cc/data/africa.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_024.bin "http://ci.zanavi.cc/data/australia_oceania.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_025.bin "http://ci.zanavi.cc/data/andorra.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_026.bin "http://ci.zanavi.cc/data/belarus.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_027.bin "http://ci.zanavi.cc/data/bosnia-herzegovina.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_028.bin "http://ci.zanavi.cc/data/croatia.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_029.bin "http://ci.zanavi.cc/data/cyprus.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_030.bin "http://ci.zanavi.cc/data/czech_republic.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_031.bin "http://ci.zanavi.cc/data/estonia.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_032.bin "http://ci.zanavi.cc/data/hungary.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_033.bin "http://ci.zanavi.cc/data/greece.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_034.bin "http://ci.zanavi.cc/data/kosovo.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_035.bin "http://ci.zanavi.cc/data/macedonia.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_036.bin "http://ci.zanavi.cc/data/moldova.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_037.bin "http://ci.zanavi.cc/data/denmark.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_038.bin "http://ci.zanavi.cc/data/russia-european-part.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_039.bin "http://ci.zanavi.cc/data/serbia.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_040.bin "http://ci.zanavi.cc/data/slovakia.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_041.bin "http://ci.zanavi.cc/data/slovenia.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_042.bin "http://ci.zanavi.cc/data/sweden.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_043.bin "http://ci.zanavi.cc/data/turkey.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_044.bin "http://ci.zanavi.cc/data/cuba.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_045.bin "http://ci.zanavi.cc/data/canada.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_049.bin "http://ci.zanavi.cc/data/restl_welt.bin"

    - du navitmap_0*bin|awk '{print $1 " + \\"}' > /tmp/sizes.txt ;echo -n "printf ' " > /tmp/calc.txt;cat /tmp/sizes.txt >> /tmp/calc.txt ; printf "0 \\\n' |bc\n" >> /tmp/calc.txt ; chmod u+x /tmp/calc.txt;eval /tmp/calc.txt > /tmp/res.txt ; printf "scale=2;`cat /tmp/res.txt` / 1024 / 1024 \n "|bc

    - mmd -i ~/zanavi/sdcard.img "::Android"
    - mmd -i ~/zanavi/sdcard.img "::Android/data"
    - mmd -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi"
    - mmd -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files"
    - mmd -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi"
    - mmd -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps"
    - mmd -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi"
    - mmd -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - mdir -i ~/zanavi/sdcard.img "::"
    - mdir -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_*.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - mdir -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - emulator -avd "$EMU_" -sdcard sdcard.img -no-audio -no-window:
        background: true
        parallel: true
    - circle-android wait-for-boot
    - sleep 20


    - mkdir ~/yaml-tests/
    - wget -t 10 -O ~/yaml-tests/yaml.zip "https://github.com/navit-gps/routing-qa/archive/master.zip"
    - cd ~/yaml-tests/ && unzip yaml.zip && cd ~/
    - fb-adb shell "mkdir -p $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/../../debug/../yamltests/" ; exit 0
    - for i in `ls -1 ~/yaml-tests/routing-qa-master/*.yaml` ; do fb-adb push "$i" "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/../../debug/../yamltests/" ; done

    - fb-adb shell "mkdir -p $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/" ; exit 0
    #- fb-adb shell "ls -al $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/" ; exit 0

    #- fb-adb push -p ~/navitmap_001.bin "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/"

    - adb install $CIRCLE_ARTIFACTS/zanavi_circleci_$CIRCLE_SHA1.apk

    - fb-adb shell am start -n com.zoffcc.applications.zanavi/com.zoffcc.applications.zanavi.Navit
    #- fb-adb shell "ls -alR $sdpath/Android/data/com.zoffcc.applications.zanavi/" ; exit 0
    - sleep 35
    - fb-adb shell am force-stop com.zoffcc.applications.zanavi
    - sleep 20
    - fb-adb shell "cd $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/ ; rm -Rf 201?-??-*"
    - sleep 10
    - fb-adb shell am start -n com.zoffcc.applications.zanavi/com.zoffcc.applications.zanavi.Navit


    #- fb-adb shell "ls -al $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/" ; exit 0
    #- mdir -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - adb logcat -v time > $CIRCLE_ARTIFACTS/adb_out.txt 2>&1 :
        background: true

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300
    
    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi

    - adb pull "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt" ~/_done_.txt ; exit 0
    - if [ ! -f ~/_done_.txt ]; then sleep 300 ; fi


    - fb-adb shell am force-stop com.zoffcc.applications.zanavi
    - sleep 40

    - fb-adb shell "cd $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/ ; ls -d 201?-??-*" > ~/tmp.txt && _dir=`cat ~/tmp.txt`; echo $_dir

    - mkdir ~/debug_output/ && cd ~/debug_output/ && fb-adb pull -p "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/../../debug/"
    - _dir=`cat ~/tmp.txt` ; mkdir -p ~/debug_results/"$_dir"/ && cd ~/debug_results/"$_dir"/ && fb-adb pull -p "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/$_dir/"
    - mkdir ~/debug_summary/ && cd ~/debug_summary/ && fb-adb pull -p "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_SUMMARY_XX_XX_.txt"
    - cd ~/debug_summary/ && fb-adb pull -p "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/_XX_XX_DURATION_XX_XX_.txt"

    - mkdir -p ~/gpx2png/out
    - mkdir -p ~/gpx2png/temp
    - cd ~/gpx2png/
    - wget -O ~/gpx2png/gpx2png.pl 'https://gitlab.com/tfscripts/openstreetmap/raw/7819b361e0084aef0015c05604df6d955d04742c/gpx2png/gpx2png.pl'
    - chmod u+x ~/gpx2png/gpx2png.pl
    - cd ~/gpx2png/temp/
    - for i in `ls -1 ~/debug_results/201?-??-*/*.gpx`; do f=`basename "$i" \.gpx`; perl ~/gpx2png/gpx2png.pl -o ~/gpx2png/out/"$f""_GPX_.png" "$i"; cp -av ~/gpx2png/out/"$f""_GPX_.png" ~/debug_output/; done ; exit 0
    - cp -av ~/yaml-tests/routing-qa-master/*.yaml $CIRCLE_TEST_REPORTS/

    - cd ~/debug_results/ && cp -av 201?-??-*/* $CIRCLE_TEST_REPORTS/
    - cd ~/debug_output/ && mkdir -p $CIRCLE_TEST_REPORTS/00__out/ && cp -av ./* $CIRCLE_TEST_REPORTS/00__out/ ; exit 0
    - cd ~/debug_summary/ && mkdir -p $CIRCLE_TEST_REPORTS/00__reports/ && cp -av ./* $CIRCLE_TEST_REPORTS/00__reports/

    - cd ~/debug_results/ && zip results.zip ../debug_output/* ../debug_summary/* 201?-??-*/* ~/yaml-tests/routing-qa-master/*.yaml && cp -av results.zip $CIRCLE_TEST_REPORTS/

    - cat ~/debug_summary/_XX_XX_SUMMARY_XX_XX_.txt
    - cat ~/debug_summary/_XX_XX_DURATION_XX_XX_.txt

    - mkdir -p $CIRCLE_TEST_REPORTS/00__zanavi-runner/
    - ju_fail=0 ; _dir=`cat ~/tmp.txt` ; count_files=`ls -1 ~/yaml-tests/routing-qa-master/*.yaml|wc -l|tr -d " "` ; cd ~/yaml-tests/routing-qa-master/ ; for i in `ls -1 *.yaml` ; do f="./debug_results/$_dir/$i"'._SUCCESS_.result.txt' ; echo "f=""$f" ; cd ~ ; if [ -f "$f" ]; then echo "OK" ; else echo "FAIL" ; ju_fail=$[ $ju_fail + 1 ] ; fi ; done ; . ~/zanavi/ci/junit_start.sh ~/ju_res.xml "$count_files" "$ju_fail" ; cd ~/yaml-tests/routing-qa-master/ ; for i in `ls -1 *.yaml` ; do f="./debug_results/$_dir/$i"'._SUCCESS_.result.txt' ; cd ~ ; if [ -f "$f" ]; then echo "OK2" ; . ~/zanavi/ci/junit_add.sh ~/ju_res.xml 0 "$i" "status" "OK" ; else echo "FAIL2" ; . ~/zanavi/ci/junit_add.sh ~/ju_res.xml 1 "$i" "status" "FAILED" ; fi ; done ; . ~/zanavi/ci/junit_end.sh ~/ju_res.xml ; exit 0
    - cp -v ~/ju_res.xml $CIRCLE_TEST_REPORTS/00__zanavi-runner/tests.xml

    # throw error if some tests failed
    - cat ~/debug_summary/_XX_XX_SUMMARY_XX_XX_.txt | grep 'RES:ERR' ; ex=$? ; ex2=$[ 1 - $ex ] ; exit $ex2

    # throw error if count of tests <> count of yaml files
    - count_done=`cat ~/debug_summary/_XX_XX_SUMMARY_XX_XX_.txt | grep 'tests:' | cut -d ':' -f 2 | tr -d " "` ; count_files=`ls -1 ~/yaml-tests/routing-qa-master/*.yaml|wc -l|tr -d " "` ; if [ $count_done != $count_files ]; then echo "COUNT ERR"; exit 1 ; else echo "COUNT OK" ; fi

    # ------ kill ----------------
    #- ps -fu ubuntu
    #- adb -s emulator-5555 emu kill ; exit 0
    #- adb -s emulator-5554 emu kill ; exit 0
    #- ps -fu ubuntu
    #- sleep 10
    #- pkill -9 -u ubuntu -f java
    #- sleep 10
    #- ps -fu ubuntu
    # ------ kill ----------------

