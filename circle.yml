machine:
  timezone:
    Europe/Vienna
  environment:
    EMU_: "zanavi21"
    XEMU_: "zanavi10"
    sdpath: "/storage/sdcard"
    Xsdpath: "/mnt/sdcard"
dependencies:
  cache_directories:
    - ~/.android
#    - .android
  pre:
    - sudo apt-get update
    - sudo apt-get install libpng12-dev
    - sudo apt-get install librsvg2-bin 
    - sudo apt-get install libfreetype6-dev
    - sudo apt-get install libdbus-glib-1-dev
    - sudo apt-get install g++
    - sudo apt-get install gettext
    - sudo apt-get install ant
    - sudo apt-get install libsaxonb-java
    - sudo apt-get install lib32stdc++6
    - sudo apt-get install lib32z1
    - sudo apt-get install zip
    - bash ci/do_android.sh
test:
  pre:
    - mksdcard -l e 20000M sdcard.img
    - echo 'mtools_skip_check=1' > ~/.mtoolsrc

    - android list targets

    - if [ "$EMU_" == "zanavi21" ]; then echo "no" | android create avd -n zanavi21 -f -t android-21 --abi default/armeabi-v7a --skin "WXGA800-7in" ; fi
    - if [ "$EMU_" == "zanavi10" ]; then echo "no" | android create avd -n zanavi10 -f -t android-10 --abi default/armeabi --skin "WVGA854" ; fi
    
    - echo "$EMU_"
    - echo "$sdpath"

    - emulator -avd "$EMU_" -sdcard sdcard.img -no-audio -no-window:
        background: true
        parallel: true
    - circle-android wait-for-boot
  override:
    - ls -al ~/android-build/navit/android/bin/
    - ls -al $CIRCLE_ARTIFACTS/
    - adb install $CIRCLE_ARTIFACTS/zanavi_circleci_$CIRCLE_SHA1.apk
    - fb-adb shell "df" ; exit 0
    - fb-adb shell "df $sdpath/" ; exit 0

    - wget --no-check-certificate -t 10 -O ~/navitmap_001.bin "http://ci.zanavi.cc/data/austria.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_002.bin "http://ci.zanavi.cc/data/germany.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_003.bin "http://ci.zanavi.cc/data/netherlands.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_004.bin "http://ci.zanavi.cc/data/belgium.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_005.bin "http://ci.zanavi.cc/data/france.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_006.bin "http://ci.zanavi.cc/data/italy.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_007.bin "http://ci.zanavi.cc/data/liechtenstein.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_008.bin "http://ci.zanavi.cc/data/luxembourg.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_009.bin "http://ci.zanavi.cc/data/switzerland.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_010.bin "http://ci.zanavi.cc/data/great_britain.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_011.bin "http://ci.zanavi.cc/data/ireland.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_012.bin "http://ci.zanavi.cc/data/lithuania.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_013.bin "http://ci.zanavi.cc/data/poland.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_014.bin "http://ci.zanavi.cc/data/spain.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_015.bin "http://ci.zanavi.cc/data/portugal.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_016.bin "http://ci.zanavi.cc/data/us-midwest.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_017.bin "http://ci.zanavi.cc/data/us-northeast.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_018.bin "http://ci.zanavi.cc/data/us-pacific.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_019.bin "http://ci.zanavi.cc/data/us-south.bin"
    - wget --no-check-certificate -t 10 -O ~/navitmap_020.bin "http://ci.zanavi.cc/data/us-west.bin"

    - wget --no-check-certificate -t 10 -O ~/navitmap_021.bin "http://ci.zanavi.cc/data/restl_welt.bin"


    - mkdir ~/yaml-tests/
    - wget -t 10 -O ~/yaml-tests/yaml.zip "https://github.com/navit-gps/routing-qa/archive/master.zip"
    - cd ~/yaml-tests/ && unzip yaml.zip && cd ~/
    - fb-adb shell "mkdir -p $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/../../debug/../yamltests/" ; exit 0
    - for i in `ls -1 ~/yaml-tests/routing-qa-master/*.yaml` ; do fb-adb push "$i" "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/../../debug/../yamltests/" ; done

    - fb-adb shell "mkdir -p $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/" ; exit 0
    - fb-adb shell "ls -al $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/" ; exit 0

    #- fb-adb push -p ~/navitmap_001.bin "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/"

    - fb-adb shell am start -n com.zoffcc.applications.zanavi/com.zoffcc.applications.zanavi.Navit
    - fb-adb shell "ls -alR $sdpath/Android/data/com.zoffcc.applications.zanavi/" ; exit 0
    - sleep 40
    - fb-adb shell am force-stop com.zoffcc.applications.zanavi ; exit 0
    - sleep 2
    - fb-adb shell am force-stop com.zoffcc.applications.zanavi ; exit 0

    # ------ kill ----------------
    - ps -fu ubuntu
    - adb -s emulator-5555 emu kill ; exit 0
    - adb -s emulator-5554 emu kill ; exit 0
    - adb -s emulator-5555 emu kill ; exit 0
    - adb -s emulator-5554 emu kill ; exit 0
    - ps -fu ubuntu

    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pkill -9 -u ubuntu -f adb ; echo "no error"
    - pkill -9 -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - ps -fu ubuntu
    - sleep 5
    - pkill -9 -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - ps -fu ubuntu
    - sleep 5
    - pkill -u ubuntu -f java ; pkill -9 -u ubuntu -f java ; echo "no error"
    - pkill -9 -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - ps -fu ubuntu
    # ------ kill ----------------



    - mdir -i ~/zanavi/sdcard.img "::"
    - mdir -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_001.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_002.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_003.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_004.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_005.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_006.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_007.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_008.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_009.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_010.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_011.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_012.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_013.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_014.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_015.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_016.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_017.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_018.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_019.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_020.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"
    - cd ~ ; mcopy -v -i ~/zanavi/sdcard.img navitmap_021.bin "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - mdir -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - emulator -avd "$EMU_" -sdcard sdcard.img -no-audio -no-window:
        background: true
        parallel: true
    - circle-android wait-for-boot

    - fb-adb shell "ls -al $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/" ; exit 0
    - mdir -i ~/zanavi/sdcard.img "::Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps"

    - fb-adb shell "cd $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/ ; rm -Rf 201?-??-*"
    - fb-adb shell am start -n com.zoffcc.applications.zanavi/com.zoffcc.applications.zanavi.Navit

#    - adb logcat -v time:
#        background: true

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300

    - sleep 300
    - sleep 300


    - fb-adb shell "cd $sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/ ; ls -d 201?-??-*" > ~/tmp.txt && _dir=`cat ~/tmp.txt`; rm -f ~/tmp.txt ; echo $_dir

    - mkdir ~/debug_output/ && cd ~/debug_output/ && fb-adb pull -p "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/zanavi/maps/../../debug/"
    - mkdir ~/debug_results/ && cd ~/debug_results/ && fb-adb pull -p "$sdpath/Android/data/com.zoffcc.applications.zanavi/files/zanavi/maps/yamltests/$_dir/"
    - cd ~/debug_output/ && cp -av ./* $CIRCLE_TEST_REPORTS/
    - cd ~/debug_results/ && cp -av 201?-??-*/* $CIRCLE_TEST_REPORTS/
    - cd ~/debug_results/ && zip results.zip 201?-??-*/* && cp -av results.zip $CIRCLE_TEST_REPORTS/
    
    # ------ kill ----------------
    - ps -fu ubuntu
    - adb -s emulator-5555 emu kill ; exit 0
    - adb -s emulator-5554 emu kill ; exit 0
    - adb -s emulator-5555 emu kill ; exit 0
    - adb -s emulator-5554 emu kill ; exit 0
    - ps -fu ubuntu

    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pkill -9 -u ubuntu -f adb ; echo "no error"
    - pkill -9 -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - ps -fu ubuntu
    - sleep 5
    - pkill -9 -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - ps -fu ubuntu
    - sleep 5
    - pkill -u ubuntu -f java ; pkill -9 -u ubuntu -f java ; echo "no error"
    - pkill -9 -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - pgrep -u ubuntu -f 'com.android.ddms.bindir' ; echo "no error"
    - ps -fu ubuntu
    # ------ kill ----------------





